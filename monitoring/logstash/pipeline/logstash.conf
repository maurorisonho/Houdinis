input {
  # Docker logs input
  tcp {
    port => 5000
    codec => json
  }
  
  udp {
    port => 5000
    codec => json
  }
  
  # Beats input (Filebeat, Metricbeat)
  beats {
    port => 5044
  }
  
  # HTTP input for application logs
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^{.*}$/ {
    json {
      source => "message"
      skip_on_invalid_json => true
    }
  }
  
  # Add Houdinis-specific fields
  if [container_name] =~ /houdinis/ {
    mutate {
      add_field => {
        "application" => "houdinis"
        "environment" => "production"
      }
    }
  }
  
  # Parse Python log levels
  if [level] {
    mutate {
      rename => { "level" => "log_level" }
    }
  }
  
  # Extract timestamp
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }
  
  # Parse exploit execution logs
  if [exploit_name] {
    mutate {
      add_tag => [ "exploit" ]
    }
  }
  
  # Parse quantum backend logs
  if [quantum_backend] {
    mutate {
      add_tag => [ "quantum" ]
    }
  }
  
  # Parse error logs
  if [log_level] == "ERROR" or [level] == "error" {
    mutate {
      add_tag => [ "error" ]
    }
    
    # Extract stack trace
    if [exc_info] {
      mutate {
        rename => { "exc_info" => "stack_trace" }
      }
    }
  }
  
  # Grok filter for unstructured logs
  grok {
    match => {
      "message" => [
        "%{TIMESTAMP_ISO8601:log_timestamp} %{LOGLEVEL:log_level} %{GREEDYDATA:log_message}",
        "%{COMBINEDAPACHELOG}"
      ]
    }
  }
  
  # GeoIP enrichment
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # User-agent parsing
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "ua"
    }
  }
  
  # Remove unnecessary fields
  mutate {
    remove_field => [ "host", "agent", "ecs", "input" ]
  }
}

output {
  # Elasticsearch output
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "houdinis-%{+YYYY.MM.dd}"
    
    # Template management
    manage_template => true
    template_name => "houdinis"
    template_overwrite => true
  }
  
  # Debug output (optional, remove in production)
  # stdout {
  #   codec => rubydebug
  # }
  
  # Conditional outputs
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "houdinis-errors-%{+YYYY.MM.dd}"
    }
  }
  
  if "exploit" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "houdinis-exploits-%{+YYYY.MM.dd}"
    }
  }
  
  if "quantum" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "houdinis-quantum-%{+YYYY.MM.dd}"
    }
  }
}
